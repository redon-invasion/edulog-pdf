<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reihenbildung — dynamic</title>
<style>
  :root { --container-width:1000px; --shape-size:90px; --row-img-w:150px; }

  body { font-family: Arial, sans-serif; margin: 20px; display: flex; justify-content: center; }
  .container { width: var(--container-width); display:flex; flex-direction:column; min-height:100vh; }

  /* Header */
  .logo { width:200px; height:50px; margin:0 auto 20px; }
  header { display:grid; grid-template-columns:1fr auto 1fr; align-items:start; margin-bottom:20px; }
  header h1 { text-align:center; color:#f08a00; margin:0; text-decoration:underline; font-size:20px; }
  .header-left, .header-right { display:flex; flex-direction:column; gap:4px; }
  .header-right { align-items:flex-end; text-align:right; }

  /* Overall bar */
  .status-section { margin-top:30px; }
  .status-title { text-align:center; font-weight:bold; margin-bottom:12px; }
  .bar-labels { display:flex; justify-content:space-between; margin:0 5px 4px 5px; font-size:13px; }
  .bar-wrapper { margin: 12px 0 8px 0; position:relative; }
  .bar-line { position:absolute; left:0; right:0; height:1px; background:#000; opacity:0.9; }
  .bar-line.top { top:-6px; } .bar-line.bottom { bottom:-6px; }
  .bar-track { position:relative; height:26px; border-radius:6px; overflow:hidden; }
  .knob { position:absolute; top:-10px; width:34px; height:34px; border-radius:50%; background:#fff; border:3px solid #ccc; box-shadow:0 2px 6px rgba(0,0,0,0.2); transform:translateX(-50%); display:flex; align-items:center; justify-content:center; font-weight:bold; }

  .combined-end-labels { display:flex; justify-content:space-between; margin-top:8px; font-weight:bold; }

  /* Sub-bar with gradient */
  .sub-bar { margin-top: 18px; position:relative; height:36px; }
  .sub-track { height:26px; border-radius:6px; overflow:hidden; position:relative; margin:5px 0; }
  .sub-label { position:absolute; top:0; bottom:0; display:flex; align-items:center; font-size:12px; pointer-events:none; }
  .sub-label.left { left:8px; justify-content:flex-start; }
  .sub-label.right { right:8px; justify-content:flex-end; text-align:right; }

  .split-line { position:absolute; top:0; bottom:0; width:2px; border-left:2px dashed rgba(0,0,0,0.4); }

  /* Detail area (shapes + rows) */
  .detail { text-align:center; margin-top:30px; }
  .detail-title { font-weight:bold; margin-bottom:8px; }

  .rows { display:flex; justify-content:center; gap:40px; margin-top:15px; }

  .label-box {
    padding: 4px 10px;
    border-radius: 4px;
    margin: 0 6px;
    font-weight: 500;
    background:#f5f5f5; /* fallback color */
  }

  .row-box {
    width:180px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    font-size:14px;
  }

  /* images: no border, fixed size, same for all */
  .row-box img {
    width:var(--row-img-w);
    height:100px;
    object-fit:contain;
    display:block;
    border: none !important; /* ensure no border */
    border-radius: 0; /* remove rounded border if present */
  }

  .row-text {
    max-width:var(--row-img-w);
    text-align:center;
    word-wrap:break-word;
    white-space:normal;
    padding:6px 8px;
  }

  .shape-desc { max-width:var(--row-img-w); text-align:center; word-wrap:break-word; white-space:normal; font-size:14px; }

  /* Assessment (do not change this box content/placement) */
  .assessment { max-width:700px; border:3px solid #3f3fe0; margin:30px auto 60px; padding:18px; color:#2d2dcd; text-align:center; border-radius:4px; background:#fff; min-height:120px; }

  /* Footer */
  .footer { margin-top:auto; display:grid; grid-template-columns:1fr 1fr 1fr 1fr; font-size:14px; padding-top:10px; border-top:1px solid #ccc; }
  .footer div:first-child { text-align:left; } .footer div:nth-child(2), .footer div:nth-child(3) { text-align:center; } .footer div:last-child { text-align:right; }

  /* small helpers */
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <section id="header-section">
    <div class="logo"><img src="logo.png" alt="Logo" style="max-width:100%;max-height:100%;"></div>
    <header>
      <div class="header-left">
        <div id="userName" style="font-weight:bold;"></div>
        <div><span class="muted">Muttersprache:</span> <span id="lang"></span></div>
        <div><span class="muted">geb.:</span> <span id="birthdate"></span> &nbsp; <span id="age"></span></div>
        <div class="muted">in D/A/CH seit: <span id="since"></span></div>
      </div>
      <h1>REIHENBILDUNG</h1>
      <div class="header-right">
        <div><span class="muted">Datum:</span> <span id="date"></span></div>
        <div>Teacher: <span id="teacher"></span></div>
      </div>
    </header>

    <!-- Status / overall bar -->
    <div class="status-section">
      <div class="status-title">GESAMTLEISTUNG</div>
      <div class="bar-labels">
        <div id="label1"></div><div id="label2"></div><div id="label3"></div><div id="label4"></div>
      </div>

      <div class="bar-wrapper">
        <div class="bar-line top"></div>
        <div class="bar-track" id="barTrack"></div>
        <div class="bar-line bottom"></div>
        <div class="knob" id="knob"></div>
      </div>

      <div class="sub-bar">
        <div class="sub-track" id="subTrack" aria-hidden="true"></div>
        <div class="sub-label left" id="subGrayLabel"></div>
        <div class="sub-label right" id="subGreenLabel"></div>
        <div class="split-line" id="splitLine" aria-hidden="true"></div>
      </div>

      <div class="combined-end-labels">
        <div id="combinedMin"></div>
        <div id="combinedMax"></div>
      </div>
    </div>
  </section>

   <!-- MIDDLE SECTION -->
  <section id="content-section">
    <div class="detail">
      <div class="detail-title">DETAILAUSWERTUNG</div>

      <div style="margin-top:12px; font-weight:bold;">Benennen der Grundformen:</div>
      <div class="rows">
        <span id="kreisLabel" class="label-box">Kreis</span>
        <span id="dreieckLabel" class="label-box">Dreieck</span>
        <span id="viereckLabel" class="label-box">Viereck</span>
      </div>

      <div style="margin-top:24px; font-weight:bold;">Reihenbildung:</div>
      <div class="rows">
        <div class="row-box">
          <img src="raupe.png" alt="Raupe">
          <div class="row-text" id="raupeText">Die Reihe konnte nicht gebildet werden.</div>
        </div>
        <div class="row-box">
          <img src="schlange.png" alt="Schlange">
          <div class="row-text" id="schlangeText">Reihe konnte in Form und Farbe nicht korrekt gebildet werden.</div>
        </div>
        <div class="row-box">
          <img src="wuerfel.png" alt="Würfel">
          <div class="row-text" id="wuerfelText">Die Reihe konnte nicht korrekt gebildet werden (mangelndes Zahlen-, bzw. Symbolverständnis).</div>
        </div>
      </div>
    </div>
  </section>


  <!-- Footer / assessment (DO NOT CHANGE THIS BOX CONTENT) -->
  <section id="footer-section">
    <div class="assessment">
      <div style="font-weight:800; margin-bottom:8px;">Beurteilung:</div>
      <div id="assessmentText"></div>
    </div>

    <div class="footer">
      <div id="footerName"></div>
      <div id="footerGeb"></div>
      <div id="footerDate"></div>
      <div id="footerTeacher"></div>
    </div>
  </section>
</div>

<script>
/* ---------- Helper utils ---------- */
function parseRanges(rangesStr = "") {
  if (!rangesStr) return [];
  return rangesStr.split(",").map(r => {
    if (r.includes("-")) {
      const [a,b] = r.split("-").map(Number);
      return { start: a, end: b };
    } else {
      const v = Number(r);
      return { start: v, end: v };
    }
  });
}
function toNum(v, fallback=0) {
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}
function normalizeColor(input, fallback="") {
  if (input === null || input === undefined) return fallback;
  let s = String(input).trim();
  if (!s) return fallback;
  if (s.startsWith("%23")) s = decodeURIComponent(s);
  if (/^[0-9a-fA-F]{6}$/.test(s)) return "#" + s;
  if (/^[0-9a-fA-F]{3}$/.test(s)) return "#" + s;
  return s;
}

/* ---------- Read params ---------- */
const params = new URLSearchParams(window.location.search);
const config = {
  name: params.get("name") || "Vorname Nachname",
  lang: params.get("lang") || "Deutsch",
  birthdate: params.get("birthdate") || "01/09/2019",
  age: params.get("age") || "6;0",
  since: params.get("since") || "01/01/2023",
  date: params.get("date") || (new Date()).toLocaleDateString('de-DE'),
  teacher: params.get("teacher") || "Max Mustermann",

  // bar scale
  min: toNum(params.get("min"), 0),
  max: toNum(params.get("max"), 13),
  score: toNum(params.get("score"), 0),

  // gradient band
  subsplit: toNum(params.get("subsplit"), 50),
  subTransition: toNum(params.get("subTransition"), 3),
  submin: toNum(params.get("submin"), 0),
  submax: toNum(params.get("submax"), 13),
  subgrayLabel: params.get("subgray") || "Weiterführende Fachdiagnostik empfohlen",
  subgreenLabel: params.get("subgreen") || "Normbereich",
  subGrayBg: normalizeColor(params.get("subGrayBg") || "#f5f5f5"),
  subGreenBg: normalizeColor(params.get("subGreenBg") || "#d5f5d5"),

  // bar gradient colors & ranges
  colors: params.get("colors") ? params.get("colors").split(",").map(c=>normalizeColor(c)) : ["#ed1b06","#ff7801","#fcc709","#fff15e","#c1ef4a","#79e607"],
  ranges: params.get("ranges") ? parseRanges(params.get("ranges")) : [{start:0,end:3},{start:4,end:5},{start:6,end:6},{start:7,end:8},{start:9,end:10},{start:11,end:11}],

  // Assessment text
  assessment: params.get("assessment") || "Die Differenzierungsleistung ist deutlich auffällig.",

  // shape colors + texts (accept both kreisColor or kreiscolor)
  kreisColor: normalizeColor(params.get("kreisColor") || params.get("kreiscolor") || "#eee"),
  dreieckColor: normalizeColor(params.get("dreieckColor") || params.get("dreieckcolor") || "#eee"),
  viereckColor: normalizeColor(params.get("viereckColor") || params.get("viereckcolor") || "#eee"),
  kreisText: params.get("kreisText") || "Kreis konnte nicht benannt werden.",
  dreieckText: params.get("dreieckText") || "Dreieck richtig benannt.",
  viereckText: params.get("viereckText") || "Viereck richtig benannt.",

  // rows text (under images) — accept names with raupe/schlange/wuerfel OR reihe1/2/3
  reihe1Text: params.get("reihe1Text") || params.get("raupeText") || "Die Reihe konnte nicht gebildet werden.",
  reihe2Text: params.get("reihe2Text") || params.get("schlangeText") || "Reihe konnte in Form und Farbe nicht korrekt gebildet werden.",
  reihe3Text: params.get("reihe3Text") || params.get("wuerfelText") || "Die Reihe konnte nicht korrekt gebildet werden.",

  // image src override (optional)
  reihe1Img: params.get("reihe1Img") || "raupe.png",
  reihe2Img: params.get("reihe2Img") || "schlange.png",
  reihe3Img: params.get("reihe3Img") || "wuerfel.png",

  // labels on the four bar segments
  label1: params.get("label1") || "stark auffällig",
  label2: params.get("label2") || "auffällig",
  label3: params.get("label3") || "unauffällig",
  label4: params.get("label4") || "besonders unauffällig"
};

/* ---------- Build bar gradient ---------- */
function buildGradient(colors, ranges, min, max) {
  if (!Array.isArray(ranges) || ranges.length === 0) return colors[0] || "#ddd";
  if (max === min) return colors[0] || "#ddd";
  const stops = [];
  for (let i=0;i<ranges.length;i++){
    const r = ranges[i];
    const color = colors[i % colors.length] || "#ddd";
    const startPct = ((r.start - min) / (max - min)) * 100;
    const endPct   = ((r.end - min) / (max - min)) * 100;
    const s = Math.max(0, Math.min(100, startPct));
    const e = Math.max(0, Math.min(100, endPct));
    stops.push(`${color} ${s}%`, `${color} ${e}%`);
  }
  return `linear-gradient(90deg, ${stops.join(",")})`;
}

/* ---------- Fill header/footer/assessment (unchanged) ---------- */
document.getElementById("userName").textContent = config.name;
document.getElementById("lang").textContent = config.lang;
document.getElementById("birthdate").textContent = config.birthdate;
document.getElementById("age").textContent = config.age;
document.getElementById("since").textContent = config.since;
document.getElementById("date").textContent = config.date;
document.getElementById("teacher").textContent = config.teacher;

document.getElementById("assessmentText").innerHTML = config.assessment;
document.getElementById("footerName").textContent = config.name;
document.getElementById("footerGeb").textContent = "geb.: " + config.birthdate;
document.getElementById("footerDate").textContent = config.date;
document.getElementById("footerTeacher").textContent = config.teacher;

/* ---------- overall bar and knob (unchanged) ---------- */
const barTrack = document.getElementById("barTrack");
barTrack.style.background = buildGradient(config.colors, config.ranges, config.min, config.max);

const knob = document.getElementById("knob");
let pct = 0;
if (config.max !== config.min) {
  pct = ((config.score - config.min) / (config.max - config.min)) * 100;
}
pct = Math.max(0, Math.min(100, isFinite(pct) ? pct : 0));
knob.style.left = pct + "%";
knob.textContent = (isFinite(config.score) ? config.score : "");

/* min / max labels for main bar (now dynamic) */
document.getElementById("combinedMin").textContent = config.min;
document.getElementById("combinedMax").textContent = config.max;

/* ---------- sub-track gradient with soft transition (unchanged) ---------- */
const subTrack = document.getElementById("subTrack");
const split = Math.max(0, Math.min(100, config.subsplit));
const tHalf = Math.max(0, Math.min(20, config.subTransition)); // safety clamp
const a = Math.max(0, split - tHalf);
const b = Math.min(100, split + tHalf);
subTrack.style.background = `linear-gradient(90deg, ${config.subGrayBg} 0%, ${config.subGrayBg} ${a}%, ${config.subGreenBg} ${b}%, ${config.subGreenBg} 100%)`;
document.getElementById("splitLine").style.left = split + "%";
document.getElementById("subGrayLabel").textContent = config.subgrayLabel;
document.getElementById("subGreenLabel").textContent = config.subgreenLabel;

/* ---------- ONLY THE MIDDLE SECTION MODIFIED BELOW ---------- */

/* Set the background colors of the label boxes (Kreis/Dreieck/Viereck).
   Use style.backgroundColor to ensure color strings (including "#...") apply. */
const kreisLabelEl = document.getElementById("kreisLabel");
const dreieckLabelEl = document.getElementById("dreieckLabel");
const viereckLabelEl = document.getElementById("viereckLabel");

if (kreisLabelEl && config.kreisColor) {
  kreisLabelEl.style.backgroundColor = config.kreisColor;
}
if (dreieckLabelEl && config.dreieckColor) {
  dreieckLabelEl.style.backgroundColor = config.dreieckColor;
}
if (viereckLabelEl && config.viereckColor) {
  viereckLabelEl.style.backgroundColor = config.viereckColor;
}

/* Images: ensure they use the optional override src if provided (safe: only if element exists) */
const imgEls = document.querySelectorAll(".row-box img");
if (imgEls && imgEls.length >= 3) {
  if (config.reihe1Img) imgEls[0].src = config.reihe1Img;
  if (config.reihe2Img) imgEls[1].src = config.reihe2Img;
  if (config.reihe3Img) imgEls[2].src = config.reihe3Img;
}

/* Set the dynamic texts under the images (accepts reihe1Text OR raupeText, etc.) */
const raupeTextEl = document.getElementById("raupeText");
const schlangeTextEl = document.getElementById("schlangeText");
const wuerfelTextEl = document.getElementById("wuerfelText");

if (raupeTextEl) raupeTextEl.textContent = config.reihe1Text;
if (schlangeTextEl) schlangeTextEl.textContent = config.reihe2Text;
if (wuerfelTextEl) wuerfelTextEl.textContent = config.reihe3Text;

/* ---------- bar label texts ---------- */
document.getElementById("label1").textContent = config.label1;
document.getElementById("label2").textContent = config.label2;
document.getElementById("label3").textContent = config.label3;
document.getElementById("label4").textContent = config.label4;
</script>
</body>
</html>
