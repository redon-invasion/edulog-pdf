<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Arbeits Blaetter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #eee;
    }

    .page {
      width: 297mm;   /* A4 landscape */
      height: 210mm;
      background: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      margin: 0 auto 10mm auto;
      padding: 20mm;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }

    h1 {
      font-size: 28px;
      color: #f1ab48;
      margin: 20px 0 4px;
      font-weight: bold;
    }

    .subtitle { font-size: 14px; margin-top: 4px; }
    .bold { font-weight: bold; }
    .logo { max-height: 40px; display: block; margin: -20px auto 8px; }

    .header-landscape {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-top: 15px;
    }
    .header-landscape .left,
    .header-landscape .right {
      font-size: 14px;
      line-height: 1.4;
      width: 25%;
    }
    .header-landscape .left div:not(:first-child) {
      margin-top: 8px;
    }
    .header-landscape .right div:not(:first-child) {
      margin-top: 8px;
    }
    .header-landscape .right { text-align: right; }
    .header-landscape .center { text-align: center; flex: 1; }

    .content { margin-top: 40px; text-align: center; }
    .content img {
      max-width: 90%;
      max-height: 120mm;
      object-fit: contain;
    }

    .page.rotated {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
      padding: 0;
    }
    .rotated-content {
      transform: rotate(90deg);
      transform-origin: center center;
      width: 210mm;
      height: 297mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 15mm;
      box-sizing: border-box;
      overflow: visible;
      position: relative;
    }

    .header-rotated {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-top: 5px;
      padding-bottom: 10px;
      width: 100%;
    }
    .header-rotated .left,
    .header-rotated .right {
      font-size: 14px;
      line-height: 1.4;
      width: 25%;
    }
    .header-rotated .right { text-align: right; }
    .header-rotated .center { 
      text-align: center; 
      flex: 1; 
      padding: 0 10px;
    }
    .header-rotated .center h1 {
      font-size: 18px;
      line-height: 1.2;
      word-wrap: break-word;
      hyphens: auto;
    }

    .consent-text {
      font-size: 11px;
      line-height: 1.45;
      text-align: justify;
      color: #000;
    }
    .consent-text h2 {
      font-size: 13px;
      margin: 0 0 8px 0;
      font-weight: bold;
      text-align: left;
    }
    .consent-text p { margin: 8px 0; }
    .consent-text ul { margin: 6px 0 10px 18px; }
    .consent-text strong { font-weight: bold; }

    .placeholder {
      width: 40%;
      border-bottom: 1px dotted #000;
      margin: 8px 0 4px;
      padding-bottom: 6px;
    }

    .signature-grid {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto 1fr 24mm 1fr auto;
      column-gap: 28px;
      align-items: start;
      margin-top: 18px;
    }

    .sig-label { grid-row: 1; font-size: 12px; color: #000; }
    .sig-label.right { text-align: right; }

    .sig-place { grid-row: 2; font-size: 12px; margin-top: 6px; }
    .sig-place.right { text-align: right; }

    .sig-line-top {
      grid-row: 3;
      border-top: 1px solid #000;
      height: 0;
      width: 100%;
    }
    .sig-line-bottom {
      grid-row: 5;
      border-top: 1px solid #000;
      height: 0;
      width: 100%;
    }

    .sig-footer {
      grid-row: 6;
      font-size: 12px;
      color: #000;
      text-align: center;
    }
    .sig-footer.right { text-align: center; }

    @media print {
      body { background: none; margin: 0; }
      .page { box-shadow: none; margin: 0; page-break-after: always; }
    }

    /* Buttons */
    .download-buttons {
      text-align: center;
      margin: 20px;
    }
    .download-buttons button {
      margin: 0 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #f07c00;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .download-buttons button:hover { background: #d96b00; }
  </style>
</head>
<body>

 <!-- Page 1 -->
  <div class="page">
    <div class="header-landscape">
      <div class="left">
        <div class="bold">#NAME#</div>
        <div>geb.: #BIRTHDATE# Alter: #AGE#</div>
        <div>In D/A/CH seit: #DAACH#</div>
      </div>
      <div class="center">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>ELTERNFRAGEBOGEN</h1>
      </div>
      <div class="right">
        <div class="bold">#COMPANY#</div>
        <div>Stadt #STADT#</div>
        <div>Datum: #DATE#</div>
      </div>
    </div>
    <div class="content"><img src="img1.png" alt="Seite 1"></div>
  </div>

  <!-- Page 2 -->
  <div class="page">
    <div class="header-landscape">
      <div class="left">
        <div class="bold">#NAME#</div>
        <div>geb.: #BIRTHDATE# <span>&nbsp; &nbsp;</span> Alter: #AGE#</div>
        <div>In D/A/CH seit: #DAACH#</div>
      </div>
      <div class="center">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>ELTERNFRAGEBOGEN</h1>
      </div>
      <div class="right">
        <div class="bold">#COMPANY#</div>
        <div>Stadt #STADT#</div>
        <div>Datum: #DATE#</div>
      </div>
    </div>
    <div class="content"><img src="img2.png" alt="Seite 2"></div>
  </div>

  <!-- Page 3 -->
  <div class="page">
    <div class="header-landscape">
      <div class="left">
        <div class="bold">#NAME#</div>
        <div>geb.: #BIRTHDATE# Alter: #AGE#</div>
        <div>In D/A/CH seit: #DAACH#</div>
      </div>
      <div class="center">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>ELTERNFRAGEBOGEN</h1>
      </div>
      <div class="right">
        <div class="bold">#COMPANY#</div>
        <div>Stadt #STADT#</div>
        <div>Datum: #DATE#</div>
      </div>
    </div>
    <div class="content"><img src="img3.png" alt="Seite 3"></div>
  </div>

  <!-- Page 4 -->
  <div class="page">
    <div class="header-landscape">
      <div class="left">
        <div class="bold">#NAME#</div>
        <div>geb.: #BIRTHDATE# Alter: #AGE#</div>
        <div>In D/A/CH seit: #DAACH#</div>
      </div>
      <div class="center">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>VISUOMOTORIK</h1>
      </div>
      <div class="right">
        <div class="bold">#COMPANY#</div>
        <div>Stadt #STADT#</div>
        <div>Datum: #DATE#</div>
      </div>
    </div>
    <div class="content"><img src="img4.png" alt="Seite 4"></div>
  </div>

  <!-- Page 5 -->
  <div class="page">
    <div class="header-landscape">
      <div class="left">
        <div class="bold">#NAME#</div>
        <div>geb.: #BIRTHDATE# Alter: #AGE#</div>
        <div>In D/A/CH seit: #DAACH#</div>
      </div>
      <div class="center">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>VISUOMOTORIK</h1>
      </div>
      <div class="right">
        <div class="bold">#COMPANY#</div>
        <div>Stadt #STADT#</div>
        <div>Datum: #DATE#</div>
      </div>
    </div>
    <div class="content"><img src="img5.png" alt="Seite 5"></div>
  </div>

  <!-- Page 6 -->
  <div class="page">
    <div class="header-landscape">
      <div class="left">
        <div class="bold">#NAME#</div>
        <div>geb.: #BIRTHDATE# Alter: #AGE#</div>
        <div>In D/A/CH seit: #DAACH#</div>
      </div>
      <div class="center">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>BEOBACHTUNG</h1>
      </div>
      <div class="right">
        <div class="bold">#COMPANY#</div>
        <div>Stadt #STADT#</div>
        <div>Datum: #DATE#</div>
      </div>
    </div>
    <div class="content"><img src="img6.png" alt="Seite 6"></div>
  </div>

  <!-- Page 7 -->
  <div class="page rotated">
    <div class="rotated-content">
      <div class="header-rotated">
        <div class="left">
          <div class="bold">Kind #NAME#</div>
          <div>geb.: #BIRTHDATE# <span>&nbsp; &nbsp;</span> Alter: #AGE#</div>
          <div>In D/A/CH seit: #DAACH#</div>
        </div>
        <div class="center">
          <img src="logo.png" alt="Logo" class="logo">
          <h1>NAMEN-SCHREIBEN / MENSCH-ZEICHNEN</h1>
        </div>
        <div class="right">
          <div class="bold">#COMPANY#</div>
          <div>Stadt #STADT#</div>
          <div>Datum: #DATE#</div>
        </div>
      </div>
    </div>
  </div>

 <!-- Page 8 (Rotated consent form, matching the scan; smaller font + aligned signature grid) -->
<div class="page rotated">
  <div class="rotated-content">
    <div class="consent-wrapper">
      <div class="consent-text">
        <h2>Ausfertigung f√ºr die Schule</h2>

        <p>Einwilligungserkl√§rung gem√§√ü DSGVO und ¬ß 203 StGB in die Erhebung und Verarbeitung von Daten</p>

        <p>Die Erkl√§rung gilt f√ºr die von Ihnen gesetzlich vertretene Person <strong>#NAME#</strong>. 
        #NAME# kann die Tragweite dieser Einwilligung noch nicht erkennen und daher keine eigene Erkl√§rungen abgeben.</p>

        <p>Hiermit willige ich</p>

<br>

        <div class="placeholder"></div>
        <div style="margin-top:4px; margin-bottom:8px;">
          (gesetzliche(r) Vertreter(in) von #NAME#)
        </div>

        <p>in die Erhebung, Speicherung und Verarbeitung von Daten durch</p>

        <p><strong>#COMPANY#</strong></p>

        <p>ein.</p>

        <p>Diese Daten beinhalten folgende personenbezogenen Daten:</p>
        <ul>
          <li>Name</li>
          <li>Vorname</li>
          <li>Geburtsdatum (#BIRTHDATE#)</li>
          <li>Adresse</li>
          <li>Telefonnummer</li>
          <li>E-Mail-Adresse</li>
        </ul>

        <p>und besondere Kategorien personenbezogener Daten im Sinne von Art. 9 DSGVO:</p>
        <ul>
          <li>Geburtsland</li>
          <li>Familiensprache</li>
          <li>in Deutschland/√ñsterreich/Schweiz seit (#DACHSINCE#)</li>
          <li>Gesundheitsdaten</li>
        </ul>

        <p>Die genannten Daten werden zum Zweck der Betrachtung und Auswertung von Sprach- und Bildungsst√§nden erhoben 
        und zudem auf den Computern und/oder Servern von #COMPANY# bzw. anderen Verwaltungsstellen gespeichert. 
        Ich willige ein, dass #COMPANY# die personenbezogenen Daten, die Gesundheitsdaten und sonstigen nach Paragraph 203 StGB 
        gesch√ºtzten Daten der von mir gesetzlich vertretenen Personen im daf√ºr erforderlichen Umfang mit beteiligten 
        medizinischen und beh√∂rdlichen Stellen teilt bzw. austauscht. 
        Die Daten k√∂nnen nur von berechtigten Personen eingesehen und bearbeitet werden.</p>

        <br>

        <p>Der/die Unterzeichnende(n) hat/haben das Recht, diese Einwilligung jederzeit ohne Angabe einer Begr√ºndung mit Wirkung f√ºr die Zukunft zu widerrufen. 
        Hierf√ºr gen√ºgt eine schriftliche Nachricht an #COMPANY#. 
        Die Rechtm√§√üigkeit der aufgrund der Einwilligung bis zum Widerruf erfolgten Erhebung, Speicherung und Verarbeitung wird durch den Widerruf nicht ber√ºhrt. 
        Der/die Unterzeichnende(n) hat/haben das Recht, dieser Einwilligungserkl√§rung nicht zuzustimmen. 
        Da der hier angebotene Dienst jedoch auf die Erhebung und Verarbeitung der zu Anfang genannten Daten angewiesen ist, 
        w√ºrde eine Nichtunterzeichnung eine Inanspruchnahme des Dienstes ausschlie√üen.</p>

        <br>

        <p>Hiermit versichere/n ich/wir, der/die Unterzeichnende(n), 
        der Erhebung und der Verarbeitung der Daten von #NAME# durch #COMPANY# 
        zum Zweck der Erhebung von Sprach- und Bildungsst√§nden <strong>freiwillig</strong> zuzustimmen 
        und √ºber die Datenverarbeitung und seine/ihre Rechte belehrt worden zu sein.</p>

        <br>

        <!-- Signature grid: two columns, rows aligned so top & bottom lines are level -->
        <div class="signature-grid" aria-label="Signatures">
          <!-- row 1: labels -->
          <div class="sig-label">(gesetzliche(r) Vertreter(in)<br>von #NAME#)</div>
          <div class="sig-label right">(2. gesetzliche(r) Vertreter(in) - falls notwendig)</div>

          <br><br>

          <!-- row 3: first (top) signature line -->
          <div class="sig-line-top"></div>
          <div class="sig-line-top right"></div>

          <!-- row 5: second (bottom) signature line -->
          <div class="sig-line-bottom"></div>
          <div class="sig-line-bottom right"></div>

          <!-- row 6: footer labels -->
          <div class="sig-footer">Ort, Datum, Unterschrift</div>
          <div class="sig-footer right">Ort, Datum, Unterschrift</div>
        </div>

      </div>
    </div>
  </div>
</div>

  <!-- Page 9 (Rotated consent form, matching the scan; smaller font + aligned signature grid) -->
<div class="page rotated">
  <div class="rotated-content">
    <div class="consent-wrapper">
      <div class="consent-text">
        <h2>Ausfertigung f√ºr die Schule</h2>

        <p>Einwilligungserkl√§rung gem√§√ü DSGVO und ¬ß 203 StGB in die Erhebung und Verarbeitung von Daten</p>

        <p>Die Erkl√§rung gilt f√ºr die von Ihnen gesetzlich vertretene Person <strong>#NAME#</strong>. 
        #NAME# kann die Tragweite dieser Einwilligung noch nicht erkennen und daher keine eigene Erkl√§rungen abgeben.</p>

        <p>Hiermit willige ich</p>

<br>

        <div class="placeholder"></div>
        <div style="margin-top:4px; margin-bottom:8px;">
          (gesetzliche(r) Vertreter(in) von #NAME#)
        </div>

        <p>in die Erhebung, Speicherung und Verarbeitung von Daten durch</p>

        <p><strong>#COMPANY#</strong></p>

        <p>ein.</p>

        <p>Diese Daten beinhalten folgende personenbezogenen Daten:</p>
        <ul>
          <li>Name</li>
          <li>Vorname</li>
          <li>Geburtsdatum (#BIRTHDATE#)</li>
          <li>Adresse</li>
          <li>Telefonnummer</li>
          <li>E-Mail-Adresse</li>
        </ul>

        <p>und besondere Kategorien personenbezogener Daten im Sinne von Art. 9 DSGVO:</p>
        <ul>
          <li>Geburtsland</li>
          <li>Familiensprache</li>
          <li>in Deutschland/√ñsterreich/Schweiz seit (#DACHSINCE#)</li>
          <li>Gesundheitsdaten</li>
        </ul>

        <p>Die genannten Daten werden zum Zweck der Betrachtung und Auswertung von Sprach- und Bildungsst√§nden erhoben 
        und zudem auf den Computern und/oder Servern von #COMPANY# bzw. anderen Verwaltungsstellen gespeichert. 
        Ich willige ein, dass #COMPANY# die personenbezogenen Daten, die Gesundheitsdaten und sonstigen nach Paragraph 203 StGB 
        gesch√ºtzten Daten der von mir gesetzlich vertretenen Personen im daf√ºr erforderlichen Umfang mit beteiligten 
        medizinischen und beh√∂rdlichen Stellen teilt bzw. austauscht. 
        Die Daten k√∂nnen nur von berechtigten Personen eingesehen und bearbeitet werden.</p>

        <br>

        <p>Der/die Unterzeichnende(n) hat/haben das Recht, diese Einwilligung jederzeit ohne Angabe einer Begr√ºndung mit Wirkung f√ºr die Zukunft zu widerrufen. 
        Hierf√ºr gen√ºgt eine schriftliche Nachricht an #COMPANY#. 
        Die Rechtm√§√üigkeit der aufgrund der Einwilligung bis zum Widerruf erfolgten Erhebung, Speicherung und Verarbeitung wird durch den Widerruf nicht ber√ºhrt. 
        Der/die Unterzeichnende(n) hat/haben das Recht, dieser Einwilligungserkl√§rung nicht zuzustimmen. 
        Da der hier angebotene Dienst jedoch auf die Erhebung und Verarbeitung der zu Anfang genannten Daten angewiesen ist, 
        w√ºrde eine Nichtunterzeichnung eine Inanspruchnahme des Dienstes ausschlie√üen.</p>

        <br>

        <p>Hiermit versichere/n ich/wir, der/die Unterzeichnende(n), 
        der Erhebung und der Verarbeitung der Daten von #NAME# durch #COMPANY# 
        zum Zweck der Erhebung von Sprach- und Bildungsst√§nden <strong>freiwillig</strong> zuzustimmen 
        und √ºber die Datenverarbeitung und seine/ihre Rechte belehrt worden zu sein.</p>

        <br>

        <!-- Signature grid: two columns, rows aligned so top & bottom lines are level -->
        <div class="signature-grid" aria-label="Signatures">
          <!-- row 1: labels -->
          <div class="sig-label">(gesetzliche(r) Vertreter(in)<br>von #NAME#)</div>
          <div class="sig-label right">(2. gesetzliche(r) Vertreter(in) - falls notwendig)</div>

          <br><br>

          <!-- row 3: first (top) signature line -->
          <div class="sig-line-top"></div>
          <div class="sig-line-top right"></div>

          <!-- row 5: second (bottom) signature line -->
          <div class="sig-line-bottom"></div>
          <div class="sig-line-bottom right"></div>

          <!-- row 6: footer labels -->
          <div class="sig-footer">Ort, Datum, Unterschrift</div>
          <div class="sig-footer right">Ort, Datum, Unterschrift</div>
        </div>

      </div>
    </div>
  </div>
</div>


  <!-- Buttons -->
  <div class="download-buttons">
    <button id="download-merged">üìÑ Alle Seiten als EIN PDF</button>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Optional: you can still keep html2pdf.bundle.min.js if needed -->
  <script src="html2pdf.bundle.min.js"></script>

    <!-- API Service -->
    <script src="../js/api-service.js"></script>
    <!-- ArbeitsBlaetter-specific API functions -->
    <script src="api-functions.js"></script>
    
    <script>
      // Initialize page with API data
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          // Show loading screen
          window.edulogApi.showLoadingScreen();
          
          // Check if we should show content (authentication check)
          const shouldShow = await window.edulogApi.shouldShowContent();
          if (!shouldShow) {
            window.edulogApi.hideLoadingScreen();
            window.edulogApi.hidePageContent();
            return;
          }
          
          // Fetch data from API specifically for ArbeitsBlaetter
          const data = await window.arbeitsBlaetterApi.fetchData();

        // Replace placeholders with real data
        const replacements = {
          "#NAME#": data.name || '',
          "#BIRTHDATE#": data.birthdate || '',
          "#AGE#": data.age || '',
          "#DAACH#": data.since || '',
          "#DATE#": data.date || '',
          "#COMPANY#": data.company || '',
          "#STADT#": data.stadt || '',
          "#DACHSINCE#": data.since || ''
        };

        
        // Replace placeholders in the document
        document.body.innerHTML = document.body.innerHTML.replace(
          /#NAME#|#BIRTHDATE#|#AGE#|#DAACH#|#DATE#|#COMPANY#|#STADT#|#DACHSINCE#/g,
          match => replacements[match]
        );
        
        // Debug: Log if any placeholders remain
        const remainingPlaceholders = document.body.innerHTML.match(/#NAME#|#BIRTHDATE#|#AGE#|#DAACH#|#DATE#|#COMPANY#|#STADT#|#DACHSINCE#/g);
        // if (remainingPlaceholders) {
        //   console.warn('Remaining placeholders:', remainingPlaceholders);
        // } else {
        //   console.log('All placeholders replaced successfully');
        // }
        
        // Hide loading screen
        window.edulogApi.hideLoadingScreen();
        
      } catch (error) {
        console.error('Failed to populate page data:', error);
        
        // Show error message to user
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #ff4444;
          color: white;
          padding: 15px;
          border-radius: 5px;
          z-index: 10000;
          max-width: 300px;
        `;
        errorDiv.innerHTML = `
          <strong>API Error:</strong><br>
          ${error.message}<br>
          <small>Check console for details</small>
        `;
        document.body.appendChild(errorDiv);
        
        // Auto-remove error after 10 seconds
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 10000);
        
        // Hide loading screen even on error
        window.edulogApi.hideLoadingScreen();
      }

      // Initialize PDF export buttons after DOM is loaded
      initializePdfButtons();
    });






    const { jsPDF } = window.jspdf;

    // Function to generate PDF filename in format: Name_Firstname_PID
    function generatePdfFilename() {
      const params = window.edulogApi.getUrlParams();
      const p_id = params.p_id || 'unknown';
      
      // Get the name from the page data (already processed)
      const nameElement = document.querySelector('.bold');
      let name = '';
      if (nameElement) {
        name = nameElement.textContent.trim();
      }
      
      // If no name found, try to get from API data
      if (!name && window.arbeitsBlaetterApi) {
        // This would need to be stored globally or passed to the function
        name = 'Unknown';
      }
      
      // Clean the name for filename (remove special characters, replace spaces with underscores)
      const cleanName = name.replace(/[^a-zA-Z√§√∂√º√Ñ√ñ√ú√ü\s]/g, '').replace(/\s+/g, '_');
      
      return `${cleanName}_${p_id}`;
    }

    async function exportMerged() {
      try {
        const pages = document.querySelectorAll('.page');
        
        if (pages.length === 0) {
          alert('No pages found to export');
          return;
        }

        // Show loading indicator for high-quality PDF generation
        const loadingIndicator = showPdfLoadingIndicator(pages.length);

        let or = 'landscape';

        // Create PDF with high quality settings
        const pdf = new jsPDF({
          unit: 'mm',
          format: 'a4',
          orientation: or,
          compress: true, // Enable compression for smaller file size
          precision: 2    // Higher precision for better quality
        });

        for (let i = 0; i < pages.length; i++) {
          const el = pages[i];
          const orientation = or;

          // Update loading progress
          updatePdfLoadingProgress(loadingIndicator, i + 1, pages.length);

          // High quality html2canvas settings
          const canvas = await html2canvas(el, {
            scale: 4,                    // Increased from 2 to 4 for higher resolution
            useCORS: true,              // Enable CORS for better image handling
            allowTaint: false,          // Prevent tainted canvas
            backgroundColor: '#ffffff',  // Ensure white background
            logging: false,             // Disable logging for cleaner output
            width: el.offsetWidth,      // Explicit width
            height: el.offsetHeight,    // Explicit height
            scrollX: 0,                 // Prevent scroll offset
            scrollY: 0,                 // Prevent scroll offset
            windowWidth: el.offsetWidth,
            windowHeight: el.offsetHeight,
            // High DPI support
            dpi: 300,                   // High DPI for crisp rendering
            // Better text rendering
            letterRendering: true,      // Better text rendering
            // Image quality settings
            imageTimeout: 15000,        // Longer timeout for images
            removeContainer: true       // Clean up after rendering
          });

          // Use PNG format for lossless quality instead of JPEG
          const imgData = canvas.toDataURL('image/png');

          if (i > 0) pdf.addPage('a4', orientation);

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Add image with high quality settings
          pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight, '', 'FAST');
        }

        // Hide loading indicator
        hidePdfLoadingIndicator(loadingIndicator);

        const filename = generatePdfFilename();
        pdf.save(`${filename}.pdf`);
      } catch (error) {
        console.error('Error exporting merged PDF:', error);
        alert('Error exporting PDF: ' + error.message);
      }
    }

    // Show loading indicator for PDF generation
    function showPdfLoadingIndicator(totalPages) {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'pdf-loading-indicator';
      loadingDiv.innerHTML = `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          font-family: Arial, sans-serif;
        ">
          <div style="
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 400px;
            margin: 20px;
          ">
            <div style="
              width: 60px;
              height: 60px;
              border: 4px solid #f3f3f3;
              border-top: 4px solid #f08a00;
              border-radius: 50%;
              animation: spin 1s linear infinite;
              margin: 0 auto 20px;
            "></div>
            <h3 style="color: #f08a00; margin: 0 0 10px 0;">PDF wird generiert...</h3>
            <p style="color: #666; margin: 0 0 15px 0;">Hochaufl√∂sende Qualit√§t wird erstellt</p>
            <div style="
              width: 100%;
              background: #f0f0f0;
              border-radius: 5px;
              overflow: hidden;
              margin-bottom: 10px;
            ">
              <div id="pdf-progress-bar" style="
                height: 20px;
                background: linear-gradient(90deg, #f08a00, #ffa500);
                width: 0%;
                transition: width 0.3s ease;
                border-radius: 5px;
              "></div>
            </div>
            <p id="pdf-progress-text" style="color: #999; font-size: 14px; margin: 0;">Seite 0 von ${totalPages}</p>
          </div>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;
      document.body.appendChild(loadingDiv);
      return loadingDiv;
    }

    // Update loading progress
    function updatePdfLoadingProgress(loadingIndicator, currentPage, totalPages) {
      const progressBar = document.getElementById('pdf-progress-bar');
      const progressText = document.getElementById('pdf-progress-text');
      
      if (progressBar && progressText) {
        const percentage = (currentPage / totalPages) * 100;
        progressBar.style.width = percentage + '%';
        progressText.textContent = `Seite ${currentPage} von ${totalPages}`;
      }
    }

    // Hide loading indicator
    function hidePdfLoadingIndicator(loadingIndicator) {
      if (loadingIndicator && loadingIndicator.parentNode) {
        loadingIndicator.parentNode.removeChild(loadingIndicator);
      }
    }


    function initializePdfButtons() {
      const downloadMergedBtn = document.getElementById('download-merged');
      
      if (downloadMergedBtn) {
        downloadMergedBtn.addEventListener('click', exportMerged);
      } else {
        console.error('Download merged button not found');
      }
    }
  </script>
</body>
</html>
