<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Figur-Grund-Sehen</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; display: flex; justify-content: center; }
  .container { width: 1000px; display: flex; flex-direction: column; min-height: 100vh; }

  /* Logo */
  .logo { width: 200px; height: 50px; margin: 0 auto 20px auto; }
  .logo img { max-width: 100%; max-height: 100%; object-fit: contain; }

  /* Header */
  header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: start; margin-bottom: 20px; }
  .header-left { display: flex; flex-direction: column; gap: 2px; }
  .header-left .bold { font-weight: bold; }
  header h1 { text-align: center; color: #f08a00; margin: 0; text-decoration: underline; font-size: 20px; }
  .header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
  .header-right .bold { font-weight: bold; }

  /* Bars */
  .status-section { margin-top: 30px; }
  .status-title { text-align: center; font-weight: bold; margin-bottom: 20px; }
  .bar-labels { display: flex; justify-content: space-between; margin: 0 5px 2px 5px; font-size: 13px; }
  .bar-wrapper { margin: 20px 0; position: relative; }
  .bar-line { position: absolute; left: 0; right: 0; height: 1px; background: #000; opacity: 0.9; }
  .bar-line.top { top: -3px; }
  .bar-line.bottom { bottom: -3px; }
  .bar-track { position: relative; height: 26px; border-radius: 6px; overflow: hidden; }
  .knob { position: absolute; top: -10px; width: 34px; height: 34px; border-radius: 50%; background: #fff; border: 3px solid #ccc; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transform: translateX(-50%); display: flex; align-items: center; justify-content: center; font-weight: bold; }
  .combined-end-labels { display: flex; justify-content: space-between; margin-top: 8px; font-weight: bold; }

  .sub-bar { margin-top: -13px; position: relative; } /* closer to bottom line */
  .sub-track { height: 26px; border-radius: 6px; overflow: hidden; position: relative; }
  .split-line { position: absolute; top: 0; bottom: 0; width: 2px; border-left: 2px dashed #333; }
  .sub-label { position: absolute; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; }
  .sub-label.left { left: 8px; }
  .sub-label.right { right: 8px; }

  /* Details */
  .detail { text-align: center; margin-top: 40px; }
  .detail-title { font-weight: bold; margin-bottom: 20px; }

  /* Table Styles */
  .table-container { display: flex; justify-content: center; margin-top: 20px; }
  .custom-table { border-collapse: collapse; width: auto; min-width: 600px; }
  .custom-table td { padding: 8px 12px; text-align: center; border: none; }
  .custom-table tr { border-bottom: 1px solid #ccc; }
  .custom-table tr:last-child { border-bottom: none; }

  /* Gradient column */
/* Gradient column */
.custom-table .gradient-cell { 
  writing-mode: vertical-rl; 
  text-orientation: mixed; 
  background: linear-gradient(180deg, #888 0%, #ccc 100%); /* flipped */
  font-weight: bold; 
  color: black;             /* black text */
  transform: rotate(180deg); /* rotate 180° */
}


  /* Stufe row label */
  .custom-table .stufe { font-weight: bold; text-align: left; }

  /* Colored labels only behind text */
.custom-table .green, .custom-table .red {
  font-weight: bold;
}
.custom-table .green span {
  /* no default background */
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
}

.custom-table .red span {
  /* no default background */
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
}



  /* Assessment Box */
  .assessment { max-width: 700px; border: 3px solid #3f3fe0; margin: 30px auto 60px; padding: 18px; color: #2d2dcd; text-align: center; border-radius: 4px; background: #fff; min-height: 120px; }

  /* Footer */
  .footer { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; font-size: 14px; padding-top: 10px; border-top: 1px solid #ccc; }
  .footer div:first-child { text-align: left; }
  .footer div:nth-child(2), .footer div:nth-child(3) { text-align: center; }
  .footer div:last-child { text-align: right; }
</style>
</head>
<body>
<div class="container">

  <!-- HEADER SECTION -->
  <section id="header-section">
    <div class="logo"><img src="logo.png" alt="Logo"></div>

    <header>
      <div class="header-left">
        <div id="userName" class="bold"></div>
        <div><span class="bold">Muttersprache:</span> <span id="lang"></span></div>
        <div>geb.: <span id="birthdate"></span> &nbsp; Alter: <span id="age"></span></div>
        <div>in D/A/CH seit: <span id="since"></span></div>
      </div>

      <h1>FIGUR-GRUND-SEHEN</h1>

      <div class="header-right">
        <div><span class="bold">Datum:</span> <span id="date"></span></div>
        <div><span id="company"></span></div>
      </div>
    </header>

    <!-- Status Section -->
    <div class="status-section">
      <div class="status-title">GESAMTLEISTUNG</div>

      <div class="bar-labels">
        <div id="label1"></div>
        <div id="label2"></div>
        <div id="label3"></div>
        <div id="label4"></div>
      </div>

      <div class="bar-wrapper">
        <div class="bar-line top"></div>
        <div class="bar-track" id="barTrack"></div>
        <div class="bar-line bottom"></div>
        <div class="knob" id="knob"></div>
      </div>

      <!-- SUB-BAR -->
      <div class="sub-bar">
        <div class="sub-track" id="subTrack">
          <div class="split-line" id="splitLine"></div>
          <div class="sub-label left">Weiterführende Fachdiagnostik empfohlen</div>
          <div class="sub-label right">Normbereich</div>
        </div>
      </div>

      <div class="combined-end-labels">
        <div id="combinedMin"></div>
        <div id="combinedMax"></div>
      </div>
    </div>
  </section>

  <!-- CONTENT SECTION with Table -->
  <section id="content-section">
    <div class="detail">
      <div class="detail-title">DETAILAUSWERTUNG</div>

      <div class="table-container">
        <table class="custom-table">
          <tr>
            <td rowspan="3" class="gradient-cell">Schwierigkeitsgrad</td>
            <td class="stufe">Formstufe 1:</td>
            <td class="green"><span id="kuh">Kuh</span></td>
            <td class="green"><span id="ente">Ente</span></td>
            <td class="red"><span id="kreis">Kreis</span></td>
            <td class="red"><span id="dreieck">Dreieck</span></td>
          </tr>
          <tr>
            <td class="stufe">Formstufe 2:</td>
            <td class="green"><span id="auto">Auto</span></td>
            <td class="green"><span id="haus">Haus</span></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td class="stufe">Formstufe 3:</td>
            <td class="green"><span id="baum">Baum</span></td>
            <td class="red"><span id="lampe">Lampe</span></td>
            <td></td>
            <td></td>
          </tr>
        </table>
      </div>
    </div>
  </section>

  <!-- FOOTER SECTION -->
  <section id="footer-section">
    <div class="assessment">
      <div style="font-weight:800; margin-bottom:8px;">Beurteilung:</div>
      <div id="assessmentText"></div>
    </div>

    <div class="footer">
      <div id="footerName"></div>
      <div id="footerGeb"></div>
      <div id="footerDate"></div>
      <div id="footerTeacher"></div>
    </div>
  </section>
</div>

<!-- Include API Service -->
<script src="../js/api-service.js"></script>
<!-- Include figurGrundS API Functions -->
<script src="api-functions.js"></script>

<script>
/* --- Parse and config --- */
function parseRanges(rangesData) {  
  if (!rangesData || rangesData === 'UNKNOWN') return [];
  
  // If it's already an array of objects, return it
  if (Array.isArray(rangesData)) {
    return rangesData;
  }
  
  // If it's a string, parse it
  if (typeof rangesData === 'string') {
    return rangesData.split(",").map(r => {
      if (r.includes("-")) {
        const [start, end] = r.split("-").map(Number);
        return { start, end };
      } else {
        const val = Number(r);
        return { start: val, end: val };
      }
    });
  }
  
  // Fallback
  return [];
}

// Global config variable - will be populated by API
let config = {};

// Initialize the page
async function initializePage() {
  try {
    // Show loading screen
    if (window.edulogApi) {
      window.edulogApi.showLoadingScreen();
    }
    
    // Fetch data from API
    if (window.figurGrundSApi) {
      const apiData = await window.figurGrundSApi.fetchData();
      
      // Build config from API data
      config = {
        name: apiData.name || '',
        lang: apiData.lang || '', 
        birthdate: apiData.birthdate || '',
        age: apiData.age || '',
        since: apiData.since || '',
        date: apiData.date || new Date().toLocaleDateString('de-DE'),
        company: apiData.company || '',
        min: (apiData.min !== 'UNKNOWN' && apiData.min !== undefined) ? Number(apiData.min) : 0,
        max: (apiData.max !== 'UNKNOWN' && apiData.max !== undefined) ? Number(apiData.max) : 13,
        score: (apiData.score !== 'UNKNOWN' && apiData.score !== undefined) ? Number(apiData.score) : 0,
        colors: (apiData.colors !== 'UNKNOWN' && apiData.colors) ? 
          (Array.isArray(apiData.colors) ? apiData.colors : apiData.colors.split(",")) : 
          [],
        ranges: parseRanges(apiData.ranges),
        assessment: (apiData.assessment !== 'UNKNOWN' && apiData.assessment) || "",
        label1: (apiData.label1 !== 'UNKNOWN' && apiData.label1) || "",
        label2: (apiData.label2 !== 'UNKNOWN' && apiData.label2) || "",
        label3: (apiData.label3 !== 'UNKNOWN' && apiData.label3) || "",
        label4: (apiData.label4 !== 'UNKNOWN' && apiData.label4) || "",
        subsplit: (apiData.subsplit !== 'UNKNOWN' && apiData.subsplit !== undefined) ? Number(apiData.subsplit) : 50,
        submin: (apiData.submin !== 'UNKNOWN' && apiData.submin !== undefined) ? Number(apiData.submin) : 0,
        submax: (apiData.submax !== 'UNKNOWN' && apiData.submax !== undefined) ? Number(apiData.submax) : 13,
        
        // FigurGrundS specific data
        kuh: (apiData.kuh !== 'UNKNOWN' && apiData.kuh) || "",
        ente: (apiData.ente !== 'UNKNOWN' && apiData.ente) || "",
        kreis: (apiData.kreis !== 'UNKNOWN' && apiData.kreis) || "",
        dreieck: (apiData.dreieck !== 'UNKNOWN' && apiData.dreieck) || "",
        auto: (apiData.auto !== 'UNKNOWN' && apiData.auto) || "",
        haus: (apiData.haus !== 'UNKNOWN' && apiData.haus) || "",
        baum: (apiData.baum !== 'UNKNOWN' && apiData.baum) || "",
        lampe: (apiData.lampe !== 'UNKNOWN' && apiData.lampe) || ""
      };
    } else {
      // Fallback to empty data if API is not available
      config = {
        name: '',
        lang: '', 
        birthdate: '',
        age: '',
        since: '',
        date: new Date().toLocaleDateString('de-DE'),
        company: '',
        min: 0,
        max: 13,
        score: 0,
        colors: [],
        ranges: [],
        assessment: '',
        label1: '',
        label2: '',
        label3: '',
        label4: '',
        subsplit: 50,
        submin: 0,
        submax: 13,
        kuh: '',
        ente: '',
        kreis: '',
        dreieck: '',
        auto: '',
        haus: '',
        baum: '',
        lampe: ''
      };
    }
    
    // Populate the page with data
    populatePage();
    
    // Hide loading screen
    if (window.edulogApi) {
      window.edulogApi.hideLoadingScreen();
    }
    
  } catch (error) {
    console.error('Error initializing page:', error);
    
    // Hide loading screen even on error
    if (window.edulogApi) {
      window.edulogApi.hideLoadingScreen();
    }
    
    // Show error message or fallback
    alert('Fehler beim Laden der Daten. Bitte versuchen Sie es erneut.');
  }
}

/* --- Fill static content --- */
function populatePage() {
  document.getElementById("userName").textContent = config.name;
  document.getElementById("lang").textContent = config.lang;
  document.getElementById("birthdate").textContent = config.birthdate;
  document.getElementById("age").textContent = config.age;
  document.getElementById("since").textContent = config.since;
  document.getElementById("date").textContent = config.date;
  document.getElementById("company").textContent = config.company;
  document.getElementById("assessmentText").innerHTML = config.assessment;
  document.getElementById("label1").textContent = config.label1;
  document.getElementById("label2").textContent = config.label2;
  document.getElementById("label3").textContent = config.label3;
  document.getElementById("label4").textContent = config.label4;

  /* --- Footer --- */
  document.getElementById("footerName").textContent = config.name;
  document.getElementById("footerGeb").textContent = "geb.: " + config.birthdate;
  document.getElementById("footerDate").textContent = config.date;
  document.getElementById("footerTeacher").textContent = config.company;

  /* --- Gradient Bar --- */
  document.getElementById("barTrack").style.background = buildGradient(config.colors, config.ranges, config.min, config.max);
  let pct = config.max !== config.min ? ((config.score - config.min) / (config.max - config.min)) * 100 : 0;
  pct = Math.max(0, Math.min(100, pct));
  document.getElementById("knob").style.left = pct + "%";
  document.getElementById("knob").textContent = config.score;
  document.getElementById("combinedMin").textContent = Math.min(config.min, config.submin);
  document.getElementById("combinedMax").textContent = Math.max(config.max, config.submax);

  /* --- Sub-bar gradient --- */
  const split = config.subsplit;
  document.getElementById("subTrack").style.background =
    `linear-gradient(to right, #f5f5f5 ${split-3}%, #70ff7c ${split+3}%)`;
  document.getElementById("splitLine").style.left = split + "%";

  /* --- Apply dynamic colors to items --- */
  ["kuh","ente","kreis","dreieck","auto","haus","baum","lampe"].forEach(id => {
    if (config[id]) {
      const el = document.getElementById(id);
      if (el) {
        el.style.background = config[id];
      }
    }
  });
}

/* --- Gradient Bar Helper Function --- */
function buildGradient(colors, ranges, min, max) {
  if (max === min) return colors[0] || "#ddd";
  let stops = [];
  for (let i = 0; i < ranges.length; i++) {
    const r = ranges[i];
    const color = colors[i % colors.length];
    const startPct = ((r.start - min) / (max - min)) * 100;
    const endPct = ((r.end - min) / (max - min)) * 100;
    stops.push(`${color} ${startPct}%`, `${color} ${endPct}%`);
  }
  return `linear-gradient(90deg, ${stops.join(",")})`;
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
